<!doctype html>
<html>
  <head>
    <title>View Counter</title>
  </head>
  <body>
    <table id = 'tabl'>
      <tr>
        <th>Website</th>
        <th>Views</th>
      </tr>
    </table>
    <script src = '/js/base64.js'></script>
    <script>
      var escaper = document.createElement('textarea');
      function escapeHTML(html) {
        escaper.textContent = html;
        return escaper.innerHTML;
      }
      function unescapeHTML(html) {
        escaper.innerHTML = html;
        return escaper.textContent;
      }
      var doreload = true;
      function reqg(e) {
        if ((e || document.hidden || window.getSelection().toString() == '') && doreload) {
          araun = JSON.parse(Base64.decode(this.responseText));
          ara = [];
          Object.keys(araun).sort(function (a, b) {
            if (a == '/') {
              return -1;
            }
            if (b == '/') {
              return 1;
            }
            sa = a.split('/').slice(1, Infinity);
            sb = b.split('/').slice(1, Infinity);
            for (var i = 0; i < Math.min(sa.length, sb.length); i++) {
              if (i < sa.length - 1 && i < sb.length - 1) {
                if (sa[i] > sb[i]) {
                  return 1;
                } else if (sa[i] < sb[i]) {
                  return -1;
                }
              } else if (i == sb.length - 1 && i != sa.length - 1) {
                return -1;
              } else if (i == sb.length - 1 && i == sa.length - 1) {
                if (sa[i] > sb[i]) {
                  return 1;
                } else if (sa[i] == sb[i]) {
                  return 0;
                } else {
                  return -1;
                }
              } else {
                return 1;
              }
            }
          }).forEach(function(key) {
            ara.push(key);
          });
          //.reduceRight((a, c) => (a.push(c), a), [])
          tabl.innerHTML = '<tr><th>Website</th><th>Views</th></tr>';
          for (var i in ara) {
            tabl.innerHTML += '<tr><td>' + escapeHTML(ara[i]) + '</td><td>' + araun[ara[i]] + '</td></tr>';
          }
        }
      }
      function ViewsReload(e) {
        if ((e || document.hidden || window.getSelection().toString() == '') && doreload) {
          var reqr = new XMLHttpRequest();
          reqr.addEventListener('load', reqg);
          reqr.open('GET', '/liveviews.dat');
          reqr.send();
        }
      }
      setInterval(ViewsReload, 1000, false);
      ViewsReload(true);
    </script>
  </body>
</html>